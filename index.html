import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, getDoc } from 'firebase/firestore';
import React, { useState, useEffect, useCallback, useMemo } from 'react';

// ====================================================================
// إعدادات فايربيس (نسخة مؤقتة للتطوير)
// ====================================================================
// ملاحظة هامة: هذه الإعدادات مؤقتة للاختبار فقط.
// لربط التطبيق بقاعدة بياناتك الأصلية، استبدل الكود بالأسفل 
// بإعدادات مشروع فايربيس الخاص بك.
// يمكنك الحصول عليها من "إعدادات المشروع" في لوحة تحكم فايربيس.
/*
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID" // This should match the projectId if you're using it for collection paths
};
const appId = "YOUR_PROJECT_ID"; // Use Project ID for collection paths for clarity
*/

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

// Initialize Firebase outside the component to avoid unnecessary re-initialization
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ====================================================================
// مكونات مساعدة
// ====================================================================

// Component to display alert messages
const MessageOverlay = ({ message, type, onClose }) => {
  if (!message) return null;

  const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';

  return (
    <div className="fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-2xl z-50 animate-fade-in-down" style={{ transition: 'all 0.3s ease-in-out' }}>
      <div className={`text-white px-6 py-3 rounded-lg flex items-center justify-between ${bgColor}`}>
        <span>{message}</span>
        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200">
          ×
        </button>
      </div>
    </div>
  );
};

// Loading Indicator Component
const LoadingSpinner = () => {
  return (
    <div className="flex justify-center items-center py-4">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p className="ml-3 text-gray-700">جارٍ التحميل...</p>
    </div>
  );
};

// ====================================================================
// شاشة تسجيل الدخول
// ====================================================================
const LoginScreen = ({ onLogin, displayMessage }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async () => {
    setLoading(true);
    // Default manager credentials
    if (username === 'Ali fahad' && password === '1995') {
      onLogin('manager', { id: 'manager_id', name: 'Ali fahad', username: 'Ali fahad' });
      displayMessage('تم تسجيل الدخول كمدير بنجاح!', 'success');
      setLoading(false);
      return;
    }

    try {
      // Input validation
      if (!username || !password) {
        displayMessage('يرجى إدخال اسم المستخدم وكلمة المرور.', 'error');
        setLoading(false);
        return;
      }
      // Search for the employee in the database
      const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
      const q = query(employeesRef, where('username', '==', username), where('password', '==', password));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        const employeeData = querySnapshot.docs[0].data();
        onLogin('employee', { id: querySnapshot.docs[0].id, ...employeeData });
        displayMessage('تم تسجيل الدخول كموظف بنجاح!', 'success');
      } else {
        displayMessage('اسم المستخدم أو كلمة المرور غير صحيحة.', 'error');
      }
    } catch (error) {
      console.error('Login error:', error);
      displayMessage('حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 flex items-center justify-center p-4">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md transform transition duration-500 hover:scale-105">
        <h2 className="text-3xl font-extrabold text-center text-blue-900 mb-8 flex items-center justify-center">
          صيدلية شمس الفرات
          <span className="ml-2 text-yellow-500 text-4xl">💊</span>
        </h2>
        <div className="mb-6">
          <label htmlFor="username" className="block text-gray-700 text-sm font-bold mb-2">اسم المستخدم:</label>
          <input
            type="text"
            id="username"
            className="shadow-md appearance-none border-b-2 border-emerald-400 rounded-md w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-600 transition duration-300"
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            placeholder="أدخل اسم المستخدم"
          />
        </div>
        <div className="mb-8">
          <label htmlFor="password" className="block text-gray-700 text-sm font-bold mb-2">كلمة المرور:</label>
          <input
            type="password"
            id="password"
            className="shadow-md appearance-none border-b-2 border-emerald-400 rounded-md w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-600 transition duration-300"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="أدخل كلمة المرور"
          />
        </div>
        <button
          onClick={handleLogin}
          className="bg-blue-700 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-full w-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
          disabled={loading}
        >
          {loading ? 'جارٍ تسجيل الدخول...' : 'تسجيل الدخول'}
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة قائمة المدير
// ====================================================================
const ManagerMenuScreen = ({ onLogout, setCurrentScreen, displayMessage, loggedInUser }) => {
  const [unreadNotesCount, setUnreadNotesCount] = useState(0);
  const [unreadPendingSubmissionsCount, setUnreadPendingSubmissionsCount] = useState(0);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribeAuth();
  }, []);

  // Fetch unread notes count
  useEffect(() => {
    if (!isAuthReady) return;

    const notesRef = collection(db, `artifacts/${appId}/public/data/employee_notes`);
    const q = query(notesRef, where('readByManager', '==', false));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setUnreadNotesCount(snapshot.size);
    }, (error) => {
      console.error('Error fetching unread notes count:', error);
      displayMessage('خطأ في جلب عدد الملاحظات غير المقروءة.', 'error');
    });
    return () => unsubscribe();
  }, [isAuthReady, displayMessage]);

  // Fetch unread pending submissions count
  useEffect(() => {
    if (!isAuthReady) return;

    const pendingSubmissionsRef = collection(db, `artifacts/${appId}/public/data/pending_submissions`);
    const unsubscribe = onSnapshot(pendingSubmissionsRef, (snapshot) => {
      setUnreadPendingSubmissionsCount(snapshot.size); // All pending are unread for manager
    }, (error) => {
      console.error('Error fetching pending submissions count:', error);
      displayMessage('خطأ في جلب عدد الإرسالات المعلقة.', 'error');
    });
    return () => unsubscribe();
  }, [isAuthReady, displayMessage]);


  // Common button style classes
  const buttonBaseClasses = "relative text-white font-bold py-8 px-6 rounded-3xl shadow-xl transition duration-300 ease-in-out transform hover:scale-105 text-xl flex flex-col items-center justify-center text-center space-y-2";

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8 flex flex-col items-center">
      <div className="w-full max-w-4xl p-10 bg-white rounded-xl shadow-2xl">
        <h2 className="text-4xl font-extrabold text-blue-800 mb-10 text-center">لوحة تحكم المدير</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 w-full">
          <button
            onClick={() => setCurrentScreen('employeeManagement')}
            className={`bg-indigo-600 hover:bg-indigo-700 ${buttonBaseClasses}`}
          >
            <svg className="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M17 20v-2c0-.653-.16-1.267-.442-1.815M14 10a6 6 0 11-12 0 6 6 0 0112 0zm-6 0a3 3 0 10-6 0 3 3 0 006 0zm-6 0a3 3 0 10-6 0 3 3 0 006 0zm-6 0a3 3 0 10-6 0 3 3 0 006 0z"></path></svg>
            إدارة الموظفين
          </button>
          <button
            onClick={() => setCurrentScreen('amountsManagement')}
            className={`bg-emerald-600 hover:bg-emerald-700 ${buttonBaseClasses}`}
          >
            <svg className="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 6v2m0 6v2"></path></svg>
            إدارة المبالغ
          </button>
          <button
            onClick={() => setCurrentScreen('salariesManagement')}
            className={`bg-purple-600 hover:bg-purple-700 ${buttonBaseClasses}`}
          >
            <svg className="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 14S6.284 5.614 5.242 2.322M9 14L8.125 10M13 18v-4h-2V6a2 2 0 012-2h4a2 2 0 012 2v4h-2v4"></path></svg>
            رواتب الموظفين
          </button>
          <button
            onClick={() => setCurrentScreen('notificationsManagement')}
            className={`bg-rose-600 hover:bg-rose-700 ${buttonBaseClasses}`}
          >
            <svg className="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0a3 3 0 11-6 0m6 0H9"></path></svg>
            إدارة الإشعارات
          </button>
          <button
            onClick={() => setCurrentScreen('employeeNotes')}
            className={`bg-blue-600 hover:bg-blue-700 ${buttonBaseClasses}`}
          >
            <svg className="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M12 16h.01"></path></svg>
            ملاحظات الموظفين
            {unreadNotesCount > 0 && (
                <span className="absolute top-3 right-3 inline-flex items-center justify-center px-3 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full animate-bounce">
                {unreadNotesCount}
                </span>
            )}
          </button>
          <button
            onClick={() => setCurrentScreen('pendingSubmissions')}
            className={`bg-orange-600 hover:bg-orange-700 ${buttonBaseClasses}`}
          >
            <svg className="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7v4m0 0l-3 3m3-3l3 3m0 0V7m0 14a2 2 0 01-2-2v-4a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2H8z"></path></svg> {/* New Icon for Pending Submissions */}
            الإرسالات المعلقة
            {unreadPendingSubmissionsCount > 0 && (
                <span className="absolute top-3 right-3 inline-flex items-center justify-center px-3 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full animate-bounce">
                {unreadPendingSubmissionsCount}
                </span>
            )}
          </button>
        </div>
        <button
          onClick={onLogout}
          className="mt-12 bg-gray-700 hover:bg-gray-800 text-white font-bold py-4 px-10 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-lg mx-auto block"
        >
          تسجيل الخروج
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة الموظف
// ====================================================================
const EmployeeScreen = ({ onLogout, displayMessage, loggedInUser, setCurrentScreen }) => {
  const [hours, setHours] = useState('');
  const [amount, setAmount] = useState('');
  const [shiftType, setShiftType] = useState('صباحي');
  const [isHoliday, setIsHoliday] = useState(false);
  const [notes, setNotes] = useState('');
  const [loading, setLoading] = useState(false);
  const [unreadNotificationsCount, setUnreadNotificationsCount] = useState(0);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribeAuth();
  }, []);

  // Fetch unread notifications count for the current employee
  useEffect(() => {
    if (!isAuthReady || !loggedInUser?.data?.id) return;

    const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
    const q = query(notificationsRef, 
        where('employee_id', '==', loggedInUser.data.id),
        where('readByEmployee', '==', false)
    );
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setUnreadNotificationsCount(snapshot.size);
    }, (error) => {
      console.error('Error fetching unread notifications count for employee:', error);
      displayMessage('خطأ في جلب عدد الإشعارات غير المقروءة.', 'error');
    });
    return () => unsubscribe();
  }, [isAuthReady, loggedInUser, displayMessage]);


  const handleSubmitWorkData = async () => {
    setLoading(true);
    try {
      if (isHoliday) {
        // Direct submission for holiday
        const workHoursRef = collection(db, `artifacts/${appId}/public/data/work_hours`);
        await addDoc(workHoursRef, {
          employee_id: loggedInUser.data.id,
          employee_name: loggedInUser.data.name,
          date: new Date().toISOString().split('T')[0],
          hours: 0,
          hourly_rate: loggedInUser.data.hourly_rate || 0,
          is_holiday: 1,
          timestamp: new Date().toISOString(), // Add timestamp for holiday records too
        });
        displayMessage('تم تسجيل الإجازة بنجاح!', 'success');
      } else {
        // Validate if at least one field is filled (hours, amount, or notes)
        if (!hours && !amount && notes.trim() === '') {
            displayMessage('الرجاء إدخال ساعات العمل، أو مبلغ الشفت، أو ملاحظة واحدة على الأقل!', 'error');
            setLoading(false);
            return;
        }

        // Validate positive values for hours and non-negative for amount
        if (hours && parseFloat(hours) <= 0) {
            displayMessage('عدد الساعات يجب أن يكون أكبر من صفر.', 'error');
            setLoading(false);
            return;
        }
        if (amount && parseFloat(amount) < 0) {
            displayMessage('المبلغ لا يمكن أن يكون سالبًا.', 'error');
            setLoading(false);
            return;
        }

        const now = new Date();
        const fourteenHoursAgo = new Date(now.getTime() - (14 * 60 * 60 * 1000));
        let lastSubmissionTime = null;

        // Check last submission timestamp
        const workHoursQuery = query(collection(db, `artifacts/${appId}/public/data/work_hours`), 
                                     where('employee_id', '==', loggedInUser.data.id),
                                     // Assuming 'timestamp' field is always present for any submission
                                     orderBy('timestamp', 'desc'), 
                                     limit(1));
        const amountsQuery = query(collection(db, `artifacts/${appId}/public/data/amounts`), 
                                   where('employee_id', '==', loggedInUser.data.id),
                                   orderBy('timestamp', 'desc'), 
                                   limit(1));
        const notesQuery = query(collection(db, `artifacts/${appId}/public/data/employee_notes`), 
                                  where('employee_id', '==', loggedInUser.data.id),
                                  orderBy('timestamp', 'desc'), 
                                  limit(1));

        const [workHoursSnapshot, amountsSnapshot, notesSnapshot] = await Promise.all([
            getDocs(workHoursQuery),
            getDocs(amountsQuery),
            getDocs(notesQuery)
        ]);

        let latestTimestamp = null;
        if (!workHoursSnapshot.empty) {
            latestTimestamp = new Date(workHoursSnapshot.docs[0].data().timestamp);
        }
        if (!amountsSnapshot.empty) {
            const currentAmountTimestamp = new Date(amountsSnapshot.docs[0].data().timestamp);
            if (!latestTimestamp || currentAmountTimestamp > latestTimestamp) {
                latestTimestamp = currentAmountTimestamp;
            }
        }
        if (!notesSnapshot.empty) {
            const currentNoteTimestamp = new Date(notesSnapshot.docs[0].data().timestamp);
            if (!latestTimestamp || currentNoteTimestamp > latestTimestamp) {
                latestTimestamp = currentNoteTimestamp;
            }
        }

        if (latestTimestamp && latestTimestamp > fourteenHoursAgo) {
            // Less than 14 hours passed, send to pending
            const pendingRef = collection(db, `artifacts/${appId}/public/data/pending_submissions`);
            await addDoc(pendingRef, {
                employee_id: loggedInUser.data.id,
                employee_name: loggedInUser.data.name,
                submitted_at: new Date().toISOString(), // Timestamp for pending record
                type: 'manual_submission', // Generic type for now
                data: { // Store all potential data
                    hours: hours ? parseFloat(hours) : null,
                    amount: amount ? parseFloat(amount) : null,
                    shift_type: amount ? shiftType : null,
                    notes: notes.trim() !== '' ? notes.trim() : null,
                    is_holiday: isHoliday, // Include holiday status for pending as well
                },
                status: 'pending',
            });
            displayMessage('تم إرسال بياناتك للموافقة. سيتم مراجعتها من قبل المدير.', 'info');
        } else {
            // 14 hours or more passed, or first submission, proceed with direct addition
            let submissionSuccessful = false;

            const currentTimestamp = new Date().toISOString(); // Consistent timestamp for all direct submissions

            if (hours) {
              const workHoursRef = collection(db, `artifacts/${appId}/public/data/work_hours`);
              await addDoc(workHoursRef, {
                employee_id: loggedInUser.data.id,
                employee_name: loggedInUser.data.name,
                date: now.toISOString().split('T')[0],
                hours: parseFloat(hours),
                hourly_rate: loggedInUser.data.hourly_rate || 0,
                is_holiday: 0,
                timestamp: currentTimestamp,
              });
              submissionSuccessful = true;
            }
            if (amount) {
              const amountsRef = collection(db, `artifacts/${appId}/public/data/amounts`);
              await addDoc(amountsRef, {
                employee_id: loggedInUser.data.id,
                employee_name: loggedInUser.data.name,
                date: now.toISOString().split('T')[0],
                shift_type: shiftType,
                amount: parseFloat(amount),
                timestamp: currentTimestamp,
              });
              submissionSuccessful = true;
            }
            if (notes.trim() !== '') {
                const notesRef = collection(db, `artifacts/${appId}/public/data/employee_notes`);
                await addDoc(notesRef, {
                    employee_id: loggedInUser.data.id,
                    employee_name: loggedInUser.data.name,
                    message: notes.trim(),
                    date: now.toISOString().split('T')[0],
                    timestamp: currentTimestamp,
                    readByManager: false, // New notes are unread for manager
                });
                submissionSuccessful = true;
            }
            
            if (submissionSuccessful) {
                displayMessage('تم حفظ البيانات بنجاح!', 'success');
            } else {
                displayMessage('لم يتم حفظ أي بيانات. يرجى إدخال معلومات صالحة.', 'info');
            }
        }
      } // End of else (not holiday)
      // Clear fields after any submission
      setHours('');
      setAmount('');
      setIsHoliday(false);
      setNotes('');
    } catch (error) {
      console.error('Error saving work data or notes:', error);
      displayMessage('حدث خطأ أثناء حفظ البيانات. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8 flex flex-col items-center justify-center">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md transform transition duration-500 hover:scale-105">
        <h2 className="text-3xl font-bold text-center text-gray-800 mb-6">شاشة الموظف</h2>
        <p className="text-center text-gray-600 mb-6">أهلاً بك، {loggedInUser.data.name}!</p>

        <div className="mb-4">
          <label htmlFor="hours" className="block text-gray-700 text-sm font-bold mb-2">عدد ساعات العمل:</label>
          <input
            type="number"
            id="hours"
            className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
            value={hours}
            onChange={(e) => setHours(e.target.value)}
            disabled={isHoliday || loading}
            placeholder="أدخل عدد الساعات"
          />
        </div>

        <div className="mb-4">
          <label htmlFor="amount" className="block text-gray-700 text-sm font-bold mb-2">مبلغ الشفت:</label>
          <input
            type="number"
            id="amount"
            className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
            value={amount}
            onChange={(e) => setAmount(e.target.value)}
            disabled={isHoliday || loading}
            placeholder="أدخل مبلغ الشفت"
          />
        </div>

        <div className="mb-4">
          <label htmlFor="shiftType" className="block text-gray-700 text-sm font-bold mb-2">نوع الشفت:</label>
          <select
            id="shiftType"
            className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
            value={shiftType}
            onChange={(e) => setShiftType(e.target.value)}
            disabled={isHoliday || loading || !amount} // Disable if no amount
          >
            <option value="صباحي">صباحي</option>
            <option value="مسائي">مسائي</option>
          </select>
        </div>

        <div className="mb-4 flex items-center">
          <input
            type="checkbox"
            id="isHoliday"
            className="form-checkbox h-5 w-5 text-emerald-600 rounded"
            checked={isHoliday}
            onChange={(e) => setIsHoliday(e.target.checked)}
            disabled={loading}
          />
          <label htmlFor="isHoliday" className="ml-2 text-gray-700 text-sm font-bold">إجازة</label>
        </div>

        {/* New Notes field */}
        <div className="mb-6">
          <label htmlFor="notes" className="block text-gray-700 text-sm font-bold mb-2">ملاحظات (اختياري):</label>
          <textarea
            id="notes"
            className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
            rows="3"
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            disabled={loading}
            placeholder="اكتب ملاحظاتك هنا..."
          ></textarea>
        </div>

        <button
          onClick={handleSubmitWorkData}
          className="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-full w-full mb-4 shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
          disabled={loading}
        >
          {loading ? 'جارٍ الحفظ...' : 'حفظ البيانات'}
        </button>

        <button
          onClick={() => setCurrentScreen('notificationLog')}
          className="relative bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full w-full mb-4 shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
          disabled={loading}
        >
          سجل الإشعارات
          {unreadNotificationsCount > 0 && (
              <span className="absolute top-1 right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full animate-bounce">
              {unreadNotificationsCount}
              </span>
          )}
        </button>

        <button
          onClick={onLogout}
          className="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105"
          disabled={loading}
        >
          تسجيل الخروج
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة إدارة الموظفين
// ====================================================================
const EmployeeManagementScreen = ({ setCurrentScreen, displayMessage }) => {
  const [employees, setEmployees] = useState([]);
  const [newEmployee, setNewEmployee] = useState({ name: '', username: '', password: '', hourly_rate: '' });
  const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
  const [editEmployeeData, setEditEmployeeData] = useState(null); // State for employee data being edited
  const [loading, setLoading] = useState(false); // Overall loading state for employee management ops
  const [isAuthReady, setIsAuthReady] = useState(false); // State to track if auth is ready

  // Listen for auth state changes to ensure Firebase is ready before fetching data
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true); // Auth is now ready
    });
    return () => unsubscribe();
  }, []);

  // Fetch employees on load - depends on isAuthReady
  useEffect(() => {
    if (!isAuthReady) {
        setEmployees([]); // Clear employees if auth is not ready
        setLoading(true); // Keep loading true while waiting for auth
        return;
    }

    setLoading(true); // Start loading for data fetch
    const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
    const unsubscribe = onSnapshot(employeesRef, (snapshot) => {
      const employeesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setEmployees(employeesList);
      setLoading(false); // End loading after data is fetched
    }, (error) => {
      console.error('Error fetching employees:', error);
      displayMessage('خطأ في جلب بيانات الموظفين.', 'error');
      setLoading(false); // End loading on error
    });

    return () => unsubscribe();
  }, [displayMessage, isAuthReady]);


  // Add new employee
  const handleAddEmployee = async () => {
    if (!newEmployee.name || !newEmployee.username || !newEmployee.password || newEmployee.hourly_rate === '') {
      displayMessage('يرجى ملء جميع حقول الموظف الجديد.', 'error');
      return;
    }
    const parsedHourlyRate = parseFloat(newEmployee.hourly_rate);
    if (isNaN(parsedHourlyRate) || parsedHourlyRate <= 0) {
      displayMessage('سعر الساعة يجب أن يكون رقمًا صالحًا وأكبر من صفر.', 'error');
      return;
    }

    setLoading(true); // Start loading for add operation
    try {
      const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
      await addDoc(employeesRef, {
        name: newEmployee.name,
        username: newEmployee.username,
        password: newEmployee.password, // In a real app, password should be hashed
        hourly_rate: parsedHourlyRate,
      });
      setNewEmployee({ name: '', username: '', password: '', hourly_rate: '' });
      displayMessage('تم إضافة الموظف بنجاح!', 'success');
    } catch (error) {
      console.error('Error adding employee:', error);
      displayMessage('حدث خطأ أثناء إضافة الموظف. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false); // Always end loading
    }
  };

  // Delete employee
  const handleDeleteEmployee = async () => {
    if (!selectedEmployeeId) {
      displayMessage('الرجاء اختيار موظف لحذفه.', 'error');
      return;
    }
    // Confirmation dialog (basic, can be replaced by a custom modal)
    if (!window.confirm('هل أنت متأكد أنك تريد حذف هذا الموظف؟ سيتم حذف جميع بياناته المرتبطة في هذا التطبيق.')) {
      return;
    }

    setLoading(true); // Start loading for delete operation
    try {
      // Delete employee document
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/employees`, selectedEmployeeId));

      // As per requirement, employee data remains in historical records.
      // So no need to delete associated work_hours, amounts, notes documents.
      // They are linked by employee_id and employee_name.

      setSelectedEmployeeId('');
      setEditEmployeeData(null); // Clear edit form if deleted employee was being edited
      displayMessage('تم حذف الموظف بنجاح!', 'success');
    } catch (error) {
      console.error('Error deleting employee:', error);
      displayMessage('حدث خطأ أثناء حذف الموظف. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false); // Always end loading
    }
  };

  // Prepare to edit employee
  const handleEditSelect = (e) => {
    const id = e.target.value;
    const employeeToEdit = employees.find(emp => emp.id === id);
    setEditEmployeeData(employeeToEdit ? { ...employeeToEdit, hourly_rate: String(employeeToEdit.hourly_rate || '') } : null);
    setSelectedEmployeeId(id);
  };

  // Update employee data
  const handleUpdateEmployee = async () => {
    if (!editEmployeeData || !editEmployeeData.id) {
      displayMessage('الرجاء اختيار موظف للتعديل.', 'error');
      return;
    }
    if (!editEmployeeData.name || !editEmployeeData.username || !editEmployeeData.password || editEmployeeData.hourly_rate === '') {
        displayMessage('يرجى ملء جميع حقول التعديل.', 'error');
        return;
    }
    const parsedHourlyRate = parseFloat(editEmployeeData.hourly_rate);
    if (isNaN(parsedHourlyRate) || parsedHourlyRate <= 0) {
      displayMessage('سعر الساعة يجب أن يكون رقمًا صالحًا وأكبر من صفر.', 'error');
      return;
    }

    setLoading(true); // Start loading for update operation
    try {
      const employeeRef = doc(db, `artifacts/${appId}/public/data/employees`, editEmployeeData.id);
      await updateDoc(employeeRef, {
        name: editEmployeeData.name,
        username: editEmployeeData.username,
        password: editEmployeeData.password, // In a real app, password should be hashed
        hourly_rate: parsedHourlyRate,
      });
      setEditEmployeeData(null); // Clear edit form
      setSelectedEmployeeId(''); // Clear selection
      displayMessage('تم تعديل بيانات الموظف بنجاح!', 'success');
    } catch (error) {
      console.error('Error updating employee:', error);
      displayMessage('حدث خطأ أثناء تعديل الموظف. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false); // Always end loading
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-2xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-8">إدارة الموظفين</h2>

        {loading && <LoadingSpinner />} {/* Show loading spinner */}

        {/* Add New Employee */}
        <div className="mb-8 p-6 border border-blue-300 rounded-lg bg-blue-50">
          <h3 className="text-xl font-semibold text-blue-700 mb-4">إضافة موظف جديد</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input
              type="text"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
              placeholder="اسم الموظف"
              value={newEmployee.name}
              onChange={(e) => setNewEmployee({ ...newEmployee, name: e.target.value })}
              disabled={loading}
            />
            <input
              type="text"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
              placeholder="اسم المستخدم"
              value={newEmployee.username}
              onChange={(e) => setNewEmployee({ ...newEmployee, username: e.target.value })}
              disabled={loading}
            />
            <input
              type="password"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
              placeholder="كلمة المرور"
              value={newEmployee.password}
              onChange={(e) => setNewEmployee({ ...newEmployee, password: e.target.value })}
              disabled={loading}
            />
            <input
              type="number"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-600 transition duration-300"
              placeholder="سعر ساعة العمل"
              value={newEmployee.hourly_rate}
              onChange={(e) => setNewEmployee({ ...newEmployee, hourly_rate: e.target.value })}
              disabled={loading}
            />
          </div>
          <button
            onClick={handleAddEmployee}
            className="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full w-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
            disabled={loading}
          >
            {loading ? 'جارٍ الإضافة...' : 'إضافة موظف'}
          </button>
        </div>

        {/* Edit Existing Employee */}
        <div className="mb-8 p-6 border border-emerald-300 rounded-lg bg-emerald-50">
          <h3 className="text-xl font-semibold text-emerald-700 mb-4">تعديل موظف</h3>
          <select
            className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300 mb-4"
            value={selectedEmployeeId}
            onChange={handleEditSelect}
            disabled={loading || employees.length === 0}
          >
            <option value="">اختر موظفًا للتعديل</option>
            {employees.map((employee) => (
              <option key={employee.id} value={employee.id}>
                {employee.name}
              </option>
            ))}
          </select>
          {editEmployeeData && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <input
                type="text"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
                placeholder="اسم الموظف"
                value={editEmployeeData.name}
                onChange={(e) => setEditEmployeeData({ ...editEmployeeData, name: e.target.value })}
                disabled={loading}
              />
              <input
                type="text"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
                placeholder="اسم المستخدم"
                value={editEmployeeData.username}
                onChange={(e) => setEditEmployeeData({ ...editEmployeeData, username: e.target.value })}
                disabled={loading}
              />
              <input
                type="password"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
                placeholder="كلمة المرور"
                value={editEmployeeData.password}
                onChange={(e) => setEditEmployeeData({ ...editEmployeeData, password: e.target.value })}
                disabled={loading}
              />
              <input
                type="number"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-600 transition duration-300"
                placeholder="سعر ساعة العمل"
                value={editEmployeeData.hourly_rate}
                onChange={(e) => setEditEmployeeData({ ...editEmployeeData, hourly_rate: e.target.value })}
                disabled={loading}
              />
              <button
                onClick={handleUpdateEmployee}
                className="col-span-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full w-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-4"
                disabled={loading}
              >
                {loading ? 'جارٍ الحفظ...' : 'حفظ التعديلات'}
              </button>
            </div>
          )}
        </div>


        {/* Delete Existing Employee */}
        <div className="p-6 border border-red-300 rounded-lg bg-red-50">
          <h3 className="text-xl font-semibold text-red-700 mb-4">حذف موظف</h3>
          <select
            className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-red-600 transition duration-300 mb-4"
            value={selectedEmployeeId}
            onChange={(e) => setSelectedEmployeeId(e.target.value)}
            disabled={loading || employees.length === 0}
          >
            <option value="">اختر موظفًا للحذف</option>
            {employees.map((employee) => (
              <option key={employee.id} value={employee.id}>
                {employee.name}
              </option>
            ))}
          </select>
          <button
            onClick={handleDeleteEmployee}
            className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full w-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
            disabled={loading || !selectedEmployeeId} // Disable if no employee selected
          >
            {loading ? 'جارٍ الحذف...' : 'حذف الموظف'}
          </button>
        </div>

        <button
          onClick={() => setCurrentScreen('managerMenu')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={loading}
        >
          العودة للقائمة الرئيسية
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة إدارة المبالغ
// ====================================================================
const AmountsManagementScreen = ({ setCurrentScreen, displayMessage }) => {
  const [amounts, setAmounts] = useState([]);
  const [startDate, setStartDate] = useState(() => {
    const today = new Date();
    return new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
  });
  const [endDate, setEndDate] = useState(() => {
    const today = new Date();
    return new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
  });
  const [loadingAmounts, setLoadingAmounts] = useState(false);
  const [employees, setEmployees] = useState([]);
  const [loadingEmployees, setLoadingEmployees] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);
  
  // State for editing modal
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [currentAmountToEdit, setCurrentAmountToEdit] = useState(null);
  const [editedAmountValue, setEditedAmountValue] = useState('');
  const [editedShiftType, setEditedShiftType] = useState('');


  // Listen for auth state changes to ensure Firebase is ready before fetching data
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribe();
  }, []);

  // Fetch employees (needed for mapping names in amounts)
  useEffect(() => {
    if (!isAuthReady) {
        setEmployees([]);
        setLoadingEmployees(true);
        return;
    }
    setLoadingEmployees(true);
    const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
    const unsubscribe = onSnapshot(employeesRef, (snapshot) => {
      const employeesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setEmployees(employeesList);
      setLoadingEmployees(false);
    }, (error) => {
      console.error('Error fetching employees for amounts:', error);
      displayMessage('خطأ في جلب بيانات الموظفين للمبالغ.', 'error');
      setLoadingEmployees(false);
    });
    return () => unsubscribe();
  }, [isAuthReady, displayMessage]);

  // Fetch amounts on screen load or date range change
  useEffect(() => {
    if (!isAuthReady || loadingEmployees || employees.length === 0) {
        setAmounts([]);
        if (loadingEmployees) {
            setLoadingAmounts(true);
        } else {
            setLoadingAmounts(false);
        }
        return;
    }

    const fetchAmounts = async () => {
      setLoadingAmounts(true);
      try {
        const amountsRef = collection(db, `artifacts/${appId}/public/data/amounts`);
        const querySnapshot = await getDocs(query(amountsRef)); // Removed orderBy for broader compatibility
        let allAmounts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Filter by date range
        const filteredAmounts = allAmounts.filter(item => {
          const itemDate = new Date(item.date);
          const start = new Date(startDate); // Use state value directly
          const end = new Date(endDate); // Use state value directly
          end.setHours(23, 59, 59, 999); // Include full end day

          return itemDate >= start && itemDate <= end;
        });
        
        const employeesMap = new Map(employees.map(emp => [emp.id, emp.name]));
        const amountsWithEmployeeNames = filteredAmounts.map(item => ({
          ...item,
          employeeName: employeesMap.get(item.employee_id) || 'غير معروف'
        }));

        setAmounts(amountsWithEmployeeNames);
      } catch (error) {
        console.error('Error fetching amounts:', error);
        displayMessage('خطأ في جلب بيانات المبالغ.', 'error');
        setAmounts([]);
      } finally {
        setLoadingAmounts(false);
      }
    };
    fetchAmounts();
  }, [startDate, endDate, displayMessage, isAuthReady, employees, loadingEmployees]);

  // Calculate totals - These are derived values, so no need for separate state or loading
  const totalMorningShift = amounts
    .filter(item => item.shift_type === 'صباحي')
    .reduce((sum, item) => sum + (item.amount || 0), 0);

  const totalEveningShift = amounts
    .filter(item => item.shift_type === 'مسائي')
    .reduce((sum, item) => sum + (item.amount || 0), 0);

  const totalOverall = totalMorningShift + totalEveningShift;
  const profitPercentage = 0.20; // 20%
  const totalProfit = totalOverall * profitPercentage;

  // Show detailed report for current month
  const handleShowDetailedReport = () => {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
    setStartDate(firstDayOfMonth);
    setEndDate(lastDayOfMonth);
    displayMessage('تم تحديث التقرير ليعرض بيانات الشهر الحالي.', 'success');
  };

  const overallLoading = loadingEmployees || loadingAmounts;

  // Handle opening edit modal
  const handleEditClick = (amountData) => {
    setCurrentAmountToEdit(amountData);
    setEditedAmountValue(String(amountData.amount));
    setEditedShiftType(amountData.shift_type);
    setIsEditModalOpen(true);
  };

  // Handle updating amount
  const handleUpdateAmount = async () => {
    if (!currentAmountToEdit || editedAmountValue === '' || isNaN(parseFloat(editedAmountValue))) {
      displayMessage('يرجى إدخال مبلغ صالح للتعديل.', 'error');
      return;
    }
    if (parseFloat(editedAmountValue) < 0) {
      displayMessage('المبلغ لا يمكن أن يكون سالبًا.', 'error');
      return;
    }

    setLoadingAmounts(true);
    try {
      const amountRef = doc(db, `artifacts/${appId}/public/data/amounts`, currentAmountToEdit.id);
      await updateDoc(amountRef, {
        amount: parseFloat(editedAmountValue),
        shift_type: editedShiftType,
        timestamp: new Date().toISOString(), // Update timestamp on edit
      });
      displayMessage('تم تعديل المبلغ بنجاح!', 'success');
      setIsEditModalOpen(false);
      setCurrentAmountToEdit(null);
    } catch (error) {
      console.error('Error updating amount:', error);
      displayMessage('حدث خطأ أثناء تعديل المبلغ. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoadingAmounts(false);
    }
  };

  // Handle deleting amount
  const handleDeleteAmount = async (id) => {
    // Replaced window.confirm with a more integrated UI message if needed, or simple direct action as requested.
    // For this example, keeping it direct.
    setLoadingAmounts(true);
    try {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/amounts`, id));
      displayMessage('تم حذف السجل بنجاح!', 'success');
    } catch (error) {
      console.error('Error deleting amount:', error);
      displayMessage('حدث خطأ أثناء حذف السجل. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoadingAmounts(false);
    }
  };


  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-3xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-6">إدارة المبالغ</h2>

        {overallLoading && <LoadingSpinner />}

        {/* Display Totals */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 text-lg font-medium text-gray-800">
          <div className="p-4 bg-emerald-100 rounded-lg shadow-md">
            مجموع مبلغ الشفت الصباحي: <span className="font-bold text-emerald-700">{totalMorningShift.toFixed(2)}</span>
          </div>
          <div className="p-4 bg-teal-100 rounded-lg shadow-md">
            مجموع مبلغ الشفت المسائي: <span className="font-bold text-teal-700">{totalEveningShift.toFixed(2)}</span>
          </div>
          <div className="p-4 bg-blue-100 rounded-lg shadow-md">
            المجموع الكلي للشفتين: <span className="font-bold text-blue-700">{totalOverall.toFixed(2)}</span>
          </div>
          <div className="p-4 bg-indigo-100 rounded-lg shadow-md">
            نسبة الأرباح (20%): <span className="font-bold text-indigo-700">{totalProfit.toFixed(2)}</span>
          </div>
        </div>

        {/* Report Options */}
        <div className="mb-8 p-6 border border-emerald-300 rounded-lg bg-emerald-50">
          <h3 className="text-xl font-semibold text-emerald-700 mb-4">خيارات التقرير</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label htmlFor="startDate" className="block text-gray-700 text-sm font-bold mb-2">من تاريخ:</label>
              <input
                type="date"
                id="startDate"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                disabled={overallLoading}
              />
            </div>
            <div>
              <label htmlFor="endDate" className="block text-gray-700 text-sm font-bold mb-2">إلى تاريخ:</label>
              <input
                type="date"
                id="endDate"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-600 transition duration-300"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                disabled={overallLoading}
              />
            </div>
          </div>
          <button
            onClick={handleShowDetailedReport}
            className="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full w-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
            disabled={overallLoading}
          >
            عرض تقرير الشهر الحالي
          </button>
        </div>

        {/* Display Detailed Amounts */}
        <div className="mb-8 p-6 border border-gray-300 rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
          <h3 className="text-xl font-semibold text-gray-700 mb-4">تفاصيل المبالغ اليومية</h3>
          {overallLoading ? ( 
            <LoadingSpinner />
          ) : amounts.length === 0 ? (
            <p className="text-gray-600 text-center">لا توجد مبالغ للفترة المحددة.</p>
          ) : (
            <table className="min-w-full bg-white rounded-lg overflow-hidden shadow-md">
              <thead className="bg-gray-200">
                <tr>
                  <th className="py-2 px-4 text-right text-gray-600">التاريخ</th>
                  <th className="py-2 px-4 text-right text-gray-600">الموظف</th>
                  <th className="py-2 px-4 text-right text-gray-600">نوع الشفت</th>
                  <th className="py-2 px-4 text-right text-gray-600">المبلغ</th>
                  <th className="py-2 px-4 text-right text-gray-600">إجراءات</th> {/* New column for actions */}
                </tr>
              </thead>
              <tbody>
                {amounts
                .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date descending
                .map((item) => ( // Use item.id as key for stability
                  <tr key={item.id} className="border-b border-gray-100 last:border-b-0">
                    <td className="py-2 px-4 text-gray-800">{item.date}</td>
                    <td className="py-2 px-4 text-gray-800">{item.employeeName}</td>
                    <td className="py-2 px-4 text-gray-800">{item.shift_type}</td>
                    <td className="py-2 px-4 text-gray-800">{item.amount !== undefined ? item.amount.toFixed(2) : 'N/A'}</td>
                    <td className="py-2 px-4 text-gray-800 flex space-x-2 justify-end">
                      <button
                        onClick={() => handleEditClick(item)}
                        className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full text-sm transition duration-300"
                        disabled={overallLoading}
                      >
                        تعديل
                      </button>
                      <button
                        onClick={() => handleDeleteAmount(item.id)}
                        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm transition duration-300"
                        disabled={overallLoading}
                      >
                        حذف
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        <button
          onClick={() => setCurrentScreen('managerMenu')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={overallLoading}
        >
          العودة للقائمة الرئيسية
        </button>
      </div>

      {/* Edit Amount Modal */}
      {isEditModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md animate-fade-in-up">
            <h3 className="text-2xl font-bold text-gray-800 mb-6 text-center">تعديل مبلغ الشفت</h3>
            <div className="mb-4">
              <label htmlFor="editAmount" className="block text-gray-700 text-sm font-bold mb-2">المبلغ:</label>
              <input
                type="number"
                id="editAmount"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
                value={editedAmountValue}
                onChange={(e) => setEditedAmountValue(e.target.value)}
                disabled={loadingAmounts}
              />
            </div>
            <div className="mb-6">
              <label htmlFor="editShiftType" className="block text-gray-700 text-sm font-bold mb-2">نوع الشفت:</label>
              <select
                id="editShiftType"
                className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
                value={editedShiftType}
                onChange={(e) => setEditedShiftType(e.target.value)}
                disabled={loadingAmounts}
              >
                <option value="صباحي">صباحي</option>
                <option value="مسائي">مسائي</option>
              </select>
            </div>
            <div className="flex justify-end space-x-4">
              <button
                onClick={() => setIsEditModalOpen(false)}
                className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300"
                disabled={loadingAmounts}
              >
                إلغاء
              </button>
              <button
                onClick={handleUpdateAmount}
                className="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300"
                disabled={loadingAmounts}
              >
                {loadingAmounts ? 'جارٍ التحديث...' : 'حفظ التعديلات'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ====================================================================
// شاشة رواتب الموظفين
// ====================================================================
const SalariesManagementScreen = ({ setCurrentScreen, displayMessage }) => {
  const [employees, setEmployees] = useState([]);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState('all'); // Default to 'all' to ensure calculation on load
  const [startDate, setStartDate] = useState(() => { // Initialize with current month's start
    const today = new Date();
    return new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
  });
  const [endDate, setEndDate] = useState(() => { // Initialize with current month's end
    const today = new Date();
    return new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
  });
  const [salaries, setSalaries] = useState([]);
  const [detailedWorkHours, setDetailedWorkHours] = useState({}); // Stores detailed work hours per employee
  const [loadingEmployees, setLoadingEmployees] = useState(true); // Loading state for employees
  const [loadingSalaries, setLoadingSalaries] = useState(false); // Loading state for salaries calculation
  const [isAuthReady, setIsAuthReady] = useState(false); // State to track if auth is ready

  // Listen for auth state changes to ensure Firebase is ready before fetching data
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true); // Auth is now ready
    });
    return () => unsubscribe();
  }, []);


  // Fetch employee list - depends on isAuthReady
  useEffect(() => {
    if (!isAuthReady) {
        setEmployees([]); // Clear employees if auth is not ready
        setLoadingEmployees(true); // Set loading to true while waiting for auth
        return;
    }

    setLoadingEmployees(true); // Start loading for employee list
    const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
    const unsubscribe = onSnapshot(employeesRef, (snapshot) => {
      const employeesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setEmployees(employeesList);
      setLoadingEmployees(false); // End loading
    }, (error) => {
      console.error('Error fetching employees for salaries:', error); // Specific error message
      displayMessage('خطأ في جلب بيانات الموظفين للرواتب.', 'error');
      setLoadingEmployees(false); // End loading on error
    });
    return () => unsubscribe();
  }, [displayMessage, isAuthReady]);

  // Calculate salaries - depends on employees list being loaded and auth ready
  const calculateSalaries = useCallback(async () => {
    // Crucial check: only proceed if auth is ready AND employees data has been loaded.
    // If employees are still loading or auth not ready, just reset salaries and keep loading true.
    if (!isAuthReady || loadingEmployees) { 
        setSalaries([]);
        setDetailedWorkHours({});
        setLoadingSalaries(true); // Keep loading true if waiting for employees
        return;
    }

    // If employees are loaded but the list is empty, there's nothing to calculate.
    if (employees.length === 0) {
        setSalaries([]);
        setDetailedWorkHours({});
        setLoadingSalaries(false); // Explicitly stop loading if no employees to process.
        return;
    }

    setLoadingSalaries(true); // Start loading for salary calculation
    try {
        let employeesToCalculate = employees;
        if (selectedEmployeeId && selectedEmployeeId !== 'all') {
            const foundEmployee = employees.find(emp => emp.id === selectedEmployeeId);
            if (!foundEmployee) {
                // If selected employee somehow not found in the current list
                displayMessage('الموظف المحدد غير موجود.', 'error');
                setSalaries([]);
                setDetailedWorkHours({});
                setLoadingSalaries(false);
                return;
            }
            employeesToCalculate = [foundEmployee];
        }

        const actualStartDate = startDate;
        const actualEndDate = endDate;

        const calculatedSalaries = [];
        const newDetailedWorkHours = {}; // To store detailed work hours for each employee
        const workHoursRef = collection(db, `artifacts/${appId}/public/data/work_hours`);

        for (const emp of employeesToCalculate) {
            const q = query(workHoursRef, where('employee_id', '==', emp.id)); // Removed orderBy for broader compatibility
            const querySnapshot = await getDocs(q);
            const employeeWorkHours = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const filteredWorkHours = employeeWorkHours.filter(wh => {
                const whDate = new Date(wh.date);
                const start = new Date(actualStartDate);
                const end = new Date(actualEndDate);
                end.setHours(23, 59, 59, 999); // Include full end day

                return whDate >= start && whDate <= end;
            });

            const totalHours = filteredWorkHours.reduce((sum, wh) => sum + (wh.is_holiday ? 0 : (wh.hours || 0)), 0);
            const hourlyRate = typeof emp.hourly_rate === 'number' ? emp.hourly_rate : parseFloat(emp.hourly_rate) || 0;
            const totalHolidays = filteredWorkHours.filter(wh => wh.is_holiday === 1).length;
            const salary = totalHours * hourlyRate;

            calculatedSalaries.push({
                employeeId: emp.id,
                employeeName: emp.name,
                totalHours: totalHours,
                hourlyRate: hourlyRate,
                totalHolidays: totalHolidays,
                salary: salary.toFixed(2),
            });

            newDetailedWorkHours[emp.id] = filteredWorkHours.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        setSalaries(calculatedSalaries);
        setDetailedWorkHours(newDetailedWorkHours);
        
        // Simpler message logic to prevent loops: only display success if new data is generated.
        // If it was already loaded and same, no message.
        if (calculatedSalaries.length > 0) { 
            displayMessage('تم حساب الرواتب بنجاح!', 'success');
        } else {
            // Only show 'no data' message if there's genuinely no data after calculation
            displayMessage('لم يتم العثور على بيانات لحساب الرواتب للفترة المحددة.', 'info');
        }
    } catch (error) {
        console.error('Error calculating salaries:', error);
        displayMessage('حدث خطأ أثناء حساب الرواتب. يرجى المحاولة مرة أخرى.', 'error');
        setSalaries([]);
        setDetailedWorkHours({});
    } finally {
        setLoadingSalaries(false); // ALWAYS end loading here, regardless of success or failure
    }
  }, [employees, selectedEmployeeId, startDate, endDate, displayMessage, isAuthReady, loadingEmployees]); // REMOVED 'salaries' from dependencies

  // THIS EFFECT IS CRITICAL: It orchestrates when calculateSalaries is called.
  useEffect(() => {
    // Only call calculateSalaries if auth is ready AND employees data is not loading.
    // The calculateSalaries function itself now handles the empty employees case.
    if (isAuthReady && !loadingEmployees) {
        calculateSalaries();
    }
  }, [selectedEmployeeId, startDate, endDate, employees, calculateSalaries, isAuthReady, loadingEmployees]);

  const overallLoading = loadingEmployees || loadingSalaries;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-3xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-6">رواتب الموظفين</h2>

        {overallLoading ? (
            <LoadingSpinner />
        ) : (
            <>
                {/* Filter Options */}
                <div className="mb-8 p-6 border border-emerald-300 rounded-lg bg-emerald-50">
                <h3 className="text-xl font-semibold text-emerald-700 mb-4">تحديد الموظف والفترة</h3>
                <div className="mb-4">
                    <label htmlFor="selectEmployee" className="block text-gray-700 text-sm font-bold mb-2">اختر موظفًا:</label>
                    <select
                    id="selectEmployee"
                    className="shadow-md appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-600"
                    value={selectedEmployeeId}
                    onChange={(e) => setSelectedEmployeeId(e.target.value)}
                    disabled={overallLoading || !isAuthReady || employees.length === 0}
                    >
                    <option value="all">جميع الموظفين</option>
                    {employees.map((employee) => (
                        <option key={employee.id} value={employee.id}>
                        {employee.name}
                        </option>
                    ))}
                    </select>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                    <label htmlFor="salaryStartDate" className="block text-gray-700 text-sm font-bold mb-2">من تاريخ:</label>
                    <input
                        type="date"
                        id="salaryStartDate"
                        className="shadow-md appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-600"
                        value={startDate}
                        onChange={(e) => setStartDate(e.target.value)}
                        disabled={overallLoading || !isAuthReady || employees.length === 0}
                    />
                    </div>
                    <div>
                    <label htmlFor="salaryEndDate" className="block text-gray-700 text-sm font-bold mb-2">إلى تاريخ:</label>
                    <input
                        type="date"
                        id="salaryEndDate"
                        className="shadow-md appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-emerald-600"
                        value={endDate}
                        onChange={(e) => setEndDate(e.target.value)}
                        disabled={overallLoading || !isAuthReady || employees.length === 0}
                    />
                    </div>
                </div>
                </div>

                {/* Display Salaries */}
                <div className="mb-8 p-6 border border-gray-300 rounded-lg bg-gray-50 max-h-96 overflow-y-auto">
                <h3 className="text-xl font-semibold text-gray-700 mb-4">نتائج الرواتب</h3>
                {salaries.length === 0 && isAuthReady && employees.length > 0 && !loadingSalaries ? (
                    <p className="text-gray-600 text-center">لا توجد رواتب لعرضها للفترة المحددة. تأكد من إدخال ساعات عمل للموظفين.</p>
                ) : salaries.length === 0 && (!isAuthReady || employees.length === 0) && !loadingSalaries ? (
                    <p className="text-gray-600 text-center">لا توجد بيانات موظفين أو ساعات عمل لحساب الرواتب.</p>
                ) : (
                    salaries.map((s) => (
                    <div key={s.employeeId} className="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50 shadow-sm">
                        <h4 className="text-lg font-bold text-blue-800 mb-2">{s.employeeName}</h4>
                        <div className="grid grid-cols-2 gap-2 text-gray-700 text-sm mb-3">
                        <p><strong>إجمالي الساعات:</strong> {s.totalHours}</p>
                        <p><strong>سعر الساعة:</strong> {s.hourlyRate}</p>
                        <p><strong>أيام الإجازة:</strong> {s.totalHolidays}</p>
                        <p><strong>الراتب الإجمالي:</strong> {s.salary}</p>
                        </div>
                        {/* Detailed Work Hours */}
                        {detailedWorkHours[s.employeeId] && detailedWorkHours[s.employeeId].length > 0 && (
                          <div className="mt-4">
                            <h5 className="text-md font-semibold text-blue-700 mb-2">تفاصيل ساعات العمل:</h5>
                            <table className="min-w-full bg-white rounded-lg overflow-hidden shadow-sm text-sm">
                              <thead className="bg-blue-100">
                                <tr>
                                  <th className="py-2 px-3 text-right text-gray-600">التاريخ</th>
                                  <th className="py-2 px-3 text-right text-gray-600">الساعات</th>
                                  <th className="py-2 px-3 text-right text-gray-600">إجازة</th>
                                </tr>
                              </thead>
                              <tbody>
                                {detailedWorkHours[s.employeeId].map((detail) => (
                                  <tr key={detail.id} className="border-b border-gray-100 last:border-b-0">
                                    <td className="py-2 px-3 text-gray-800">{detail.date}</td>
                                    <td className="py-2 px-3 text-gray-800">{detail.is_holiday ? 'إجازة' : (detail.hours !== undefined ? detail.hours : 'N/A')}</td>
                                    <td className="py-2 px-3 text-gray-800">{detail.is_holiday ? 'نعم' : 'لا'}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )}
                    </div>
                    ))
                )}
                </div>
            </>
        )}

        <button
          onClick={() => setCurrentScreen('managerMenu')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={overallLoading}
        >
          العودة للقائمة الرئيسية
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة إدارة الإشعارات
// ====================================================================
const NotificationsManagementScreen = ({ setCurrentScreen, displayMessage }) => {
  const [employees, setEmployees] = useState([]);
  const [notifications, setNotifications] = useState([]); // State for existing notifications
  const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
  const [notificationMessage, setNotificationMessage] = useState('');
  const [sendTime, setSendTime] = useState('');
  const [repeatDaily, setRepeatDaily] = useState(false);
  const [loadingEmployees, setLoadingEmployees] = useState(true); // Loading state for employees
  const [loadingNotifications, setLoadingNotifications] = useState(true); // Loading state for notifications
  const [isAuthReady, setIsAuthReady] = useState(false); // State to track if auth is ready

  // 1. Track Auth Ready State
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribe();
  }, []);

  // 2. Fetch Employees (only when auth is ready)
  useEffect(() => {
    if (!isAuthReady) {
      setEmployees([]); // Clear employees if auth is not ready
      setLoadingEmployees(true); // Set loading to true while waiting for auth
      return;
    }

    setLoadingEmployees(true);
    const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
    const unsubscribe = onSnapshot(employeesRef, (snapshot) => {
      const employeesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setEmployees(employeesList);
      setLoadingEmployees(false);
    }, (error) => {
      console.error('Error listening to employees in notifications screen:', error);
      displayMessage('خطأ في جلب بيانات الموظفين.', 'error');
      setLoadingEmployees(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, displayMessage]);

  // 3. Fetch Notifications (when auth is ready AND employees data is loaded)
  useEffect(() => {
    if (!isAuthReady || loadingEmployees || employees.length === 0) { // Wait for auth and employees to load
        setNotifications([]); // Clear old notifications while waiting
        // Only set loading true if employees are still loading, otherwise it might be legitimately empty
        if (loadingEmployees) {
            setLoadingNotifications(true);
        } else {
            setLoadingNotifications(false); // If employees are loaded but list is empty, notifications will be empty
        }
        return;
    }

    const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
    setLoadingNotifications(true); // Set loading for notifications fetch
    // Remove orderBy for broader compatibility
    const unsubscribe = onSnapshot(notificationsRef, (snapshot) => {
      const notifsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Use the current 'employees' state to map names
      const employeesMap = new Map(employees.map(emp => [emp.id, emp.name]));
      const notifsWithNames = notifsList.map(notif => ({
        ...notif,
        employeeName: employeesMap.get(notif.employee_id) || 'غير معروف'
      }));
      setNotifications(notifsWithNames.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
      setLoadingNotifications(false);
    }, (error) => {
      console.error('Error listening to notifications:', error);
      displayMessage('خطأ في جلب الإشعارات.', 'error');
      setLoadingNotifications(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, employees, displayMessage, loadingEmployees]); // Depend on employees to re-map names if employee data changes


  // Send notification
  const handleSendNotification = async () => {
    if (!selectedEmployeeId || !notificationMessage || !sendTime) {
      displayMessage('يرجى ملء جميع حقول الإشعار.', 'error');
      return;
    }
    setLoadingNotifications(true); // Start loading for send operation
    try {
      const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
      await addDoc(notificationsRef, {
        employee_id: selectedEmployeeId,
        message: notificationMessage,
        time: sendTime,
        repeat_daily: repeatDaily ? 1 : 0,
        timestamp: new Date().toISOString(), // Record send time
        readByEmployee: false, // New notification is unread by employee
      });
      setNotificationMessage('');
      setSendTime('');
      setRepeatDaily(false);
      setSelectedEmployeeId('');
      displayMessage('تم إرسال الإشعار بنجاح!', 'success');
    } catch (error) {
      console.error('Error sending notification:', error);
      displayMessage('حدث خطأ أثناء إرسال الإشعار. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoadingNotifications(false);
    }
  };

  // Delete notification
  const handleDeleteNotification = async (id) => {
    setLoadingNotifications(true); // Start loading for delete operation
    try {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/notifications`, id));
      displayMessage('تم حذف الإشعار بنجاح!', 'success');
    } catch (error) {
      console.error('Error deleting notification:', error);
      displayMessage('حدث خطأ أثناء حذف الإشعار. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoadingNotifications(false);
    }
  };

  const overallLoading = loadingEmployees || loadingNotifications;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-3xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-6">إدارة الإشعارات</h2>

        {overallLoading && <LoadingSpinner />}

        <div className="mb-8 p-6 border border-blue-300 rounded-lg bg-blue-50">
          <h3 className="text-xl font-semibold text-blue-700 mb-4">إرسال إشعار جديد</h3>
          <div className="mb-4">
            <label htmlFor="selectEmployeeNotif" className="block text-gray-700 text-sm font-bold mb-2">اختر الموظف:</label>
            <select
              id="selectEmployeeNotif"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
              value={selectedEmployeeId}
              onChange={(e) => setSelectedEmployeeId(e.target.value)}
              disabled={overallLoading || employees.length === 0}
            >
              <option value="">اختر موظفًا</option>
              {employees.map((employee) => (
                <option key={employee.id} value={employee.id}>
                  {employee.name}
                </option>
              ))}
            </select>
          </div>
          <div className="mb-4">
            <label htmlFor="notificationMessage" className="block text-gray-700 text-sm font-bold mb-2">نص الإشعار:</label>
            <textarea
              id="notificationMessage"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
              rows="4"
              placeholder="اكتب نص الإشعار هنا..."
              value={notificationMessage}
              onChange={(e) => setNotificationMessage(e.target.value)}
              disabled={overallLoading}
            ></textarea>
          </div>
          <div className="mb-4">
            <label htmlFor="sendTime" className="block text-gray-700 text-sm font-bold mb-2">وقت الإرسال:</label>
            <input
              type="datetime-local"
              id="sendTime"
              className="shadow-md appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-600 transition duration-300"
              value={sendTime}
              onChange={(e) => setSendTime(e.target.value)}
              disabled={overallLoading}
            />
          </div>
          <div className="mb-6 flex items-center">
            <input
              type="checkbox"
              id="repeatDaily"
              className="form-checkbox h-5 w-5 text-emerald-600 rounded"
              checked={repeatDaily}
              onChange={(e) => setRepeatDaily(e.target.checked)}
              disabled={overallLoading}
            />
            <label htmlFor="repeatDaily" className="ml-2 text-gray-700 text-sm font-bold">تكرار يوميًا</label>
          </div>
          <button
            onClick={handleSendNotification}
            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full w-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
            disabled={overallLoading}
          >
            {overallLoading ? 'جارٍ الإرسال...' : 'إرسال الإشعار'}
          </button>
        </div>

        {/* Display Existing Notifications */}
        <div className="mb-8 p-6 border border-gray-300 rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
          <h3 className="text-xl font-semibold text-gray-700 mb-4">الإشعارات المرسلة</h3>
          {overallLoading ? (
            <LoadingSpinner />
          ) : notifications.length === 0 && isAuthReady && employees.length > 0 ? (
            <p className="text-gray-600 text-center">لا توجد إشعارات مرسلة بعد.</p>
          ) : notifications.length === 0 && (!isAuthReady || employees.length === 0) ? (
            <p className="text-gray-600 text-center">جارٍ تحميل بيانات الموظفين والإشعارات...</p>
          ) : (
            <table className="min-w-full bg-white rounded-lg overflow-hidden shadow-md">
              <thead className="bg-gray-200">
                <tr>
                  <th className="py-2 px-4 text-right text-gray-600">الموظف</th>
                  <th className="py-2 px-4 text-right text-gray-600">نص الإشعار</th>
                  <th className="py-2 px-4 text-right text-gray-600">وقت الإرسال</th>
                  <th className="py-2 px-4 text-right text-gray-600">يتكرر يوميًا؟</th>
                  <th className="py-2 px-4 text-right text-gray-600">إجراء</th>
                </tr>
              </thead>
              <tbody>
                {notifications.map((notif) => (
                  <tr key={notif.id} className="border-b border-gray-100 last:border-b-0">
                    <td className="py-2 px-4 text-gray-800">{notif.employeeName}</td>
                    <td className="py-2 px-4 text-gray-800">{notif.message}</td>
                    <td className="py-2 px-4 text-gray-800">{notif.time}</td>
                    <td className="py-2 px-4 text-gray-800">{notif.repeat_daily ? 'نعم' : 'لا'}</td>
                    <td className="py-2 px-4 text-gray-800">
                      <button
                        onClick={() => handleDeleteNotification(notif.id)}
                        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm transition duration-300 ease-in-out"
                        disabled={overallLoading}
                      >
                        حذف
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        <button
          onClick={() => setCurrentScreen('managerMenu')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={overallLoading}
        >
          العودة للقائمة الرئيسية
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة ملاحظات الموظفين (Employee Notes)
// ====================================================================
const EmployeeNotesScreen = ({ setCurrentScreen, displayMessage }) => {
  const [notes, setNotes] = useState([]);
  const [employees, setEmployees] = useState([]);
  const [loadingNotes, setLoadingNotes] = useState(true);
  const [loadingEmployees, setLoadingEmployees] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribe();
  }, []);

  // Fetch employees to map IDs to names
  useEffect(() => {
    if (!isAuthReady) {
      setEmployees([]);
      setLoadingEmployees(true);
      return;
    }
    setLoadingEmployees(true);
    const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
    const unsubscribe = onSnapshot(employeesRef, (snapshot) => {
      const employeesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setEmployees(employeesList);
      setLoadingEmployees(false);
    }, (error) => {
      console.error('Error fetching employees for notes screen:', error);
      displayMessage('خطأ في جلب بيانات الموظفين.', 'error');
      setLoadingEmployees(false);
    });
    return () => unsubscribe();
  }, [isAuthReady, displayMessage]);

  // Fetch notes
  useEffect(() => {
    if (!isAuthReady || loadingEmployees || employees.length === 0) {
      setNotes([]);
      if (loadingEmployees) {
        setLoadingNotes(true);
      } else {
        setLoadingNotes(false);
      }
      return;
    }

    setLoadingNotes(true);
    const notesRef = collection(db, `artifacts/${appId}/public/data/employee_notes`);
    const unsubscribe = onSnapshot(notesRef, (snapshot) => {
      const notesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Map employee names to notes
      const employeesMap = new Map(employees.map(emp => [emp.id, emp.name]));
      const notesWithNames = notesList.map(note => ({
        ...note,
        employeeName: employeesMap.get(note.employee_id) || 'غير معروف'
      }));

      // Sort notes by timestamp descending (most recent first)
      notesWithNames.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      setNotes(notesWithNames);
      setLoadingNotes(false);

      // Mark notes as read when manager views them
      const unreadNotesBatch = notesList.filter(note => note.readByManager === false);
      if (unreadNotesBatch.length > 0) {
        const batch = [];
        for (const note of unreadNotesBatch) {
            batch.push(updateDoc(doc(db, `artifacts/${appId}/public/data/employee_notes`, note.id), { readByManager: true }));
        }
        // Execute batch update in background, no need to await for UI
        Promise.all(batch).catch(error => console.error("Error marking notes as read:", error));
      }

    }, (error) => {
      console.error('Error fetching employee notes:', error);
      displayMessage('خطأ في جلب ملاحظات الموظفين.', 'error');
      setLoadingNotes(false);
    });
    return () => unsubscribe();
  }, [isAuthReady, employees, displayMessage, loadingEmployees]);


  const overallLoading = loadingNotes || loadingEmployees;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-3xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-8">ملاحظات الموظفين</h2>

        {overallLoading && <LoadingSpinner />}

        <div className="mb-8 p-6 border border-gray-300 rounded-lg bg-gray-50 max-h-96 overflow-y-auto">
          <h3 className="text-xl font-semibold text-gray-700 mb-4">قائمة الملاحظات</h3>
          {overallLoading ? (
            <LoadingSpinner />
          ) : notes.length === 0 ? (
            <p className="text-gray-600 text-center">لا توجد ملاحظات لعرضها.</p>
          ) : (
            <div className="space-y-4">
              {notes.map((note) => (
                <div key={note.id} className="p-4 bg-white rounded-lg shadow-md border border-blue-100">
                  <p className="font-semibold text-blue-700 mb-1">{note.employeeName}</p>
                  <p className="text-gray-800 mb-2">{note.message}</p>
                  <p className="text-sm text-gray-500 text-left">التاريخ: {note.date}</p>
                </div>
              ))}
            </div>
          )}
        </div>

        <button
          onClick={() => setCurrentScreen('managerMenu')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={overallLoading}
        >
          العودة للقائمة الرئيسية
        </button>
      </div>
    </div>
  );
};

// ====================================================================
// شاشة سجل الإشعارات للموظف
// ====================================================================
const NotificationLogScreen = ({ setCurrentScreen, displayMessage, loggedInUser }) => {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!isAuthReady || !loggedInUser?.data?.id) {
      setLoading(true);
      return;
    }

    setLoading(true);
    const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
    const q = query(notificationsRef, where('employee_id', '==', loggedInUser.data.id));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const notifsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      notifsList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Most recent first
      setNotifications(notifsList);
      setLoading(false);

      // Mark notifications as read
      const unreadNotificationsBatch = notifsList.filter(notif => notif.readByEmployee === false);
      if (unreadNotificationsBatch.length > 0) {
        const batch = [];
        for (const notif of unreadNotificationsBatch) {
            batch.push(updateDoc(doc(db, `artifacts/${appId}/public/data/notifications`, notif.id), { readByEmployee: true }));
        }
        // Execute batch update in background, no need to await for UI
        Promise.all(batch).catch(error => console.error("Error marking notifications as read:", error));
      }
    }, (error) => {
      console.error('Error fetching employee notifications log:', error);
      displayMessage('خطأ في جلب سجل الإشعارات.', 'error');
      setLoading(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, loggedInUser, displayMessage]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-3xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-8">سجل الإشعارات</h2>

        {loading && <LoadingSpinner />}

        <div className="mb-8 p-6 border border-gray-300 rounded-lg bg-gray-50 max-h-96 overflow-y-auto">
          <h3 className="text-xl font-semibold text-gray-700 mb-4">إشعاراتي</h3>
          {loading ? (
            <LoadingSpinner />
          ) : notifications.length === 0 ? (
            <p className="text-gray-600 text-center">لا توجد إشعارات لعرضها.</p>
          ) : (
            <div className="space-y-4">
              {notifications.map((notif) => (
                <div 
                  key={notif.id} 
                  className={`p-4 rounded-lg shadow-md border ${notif.readByEmployee ? 'bg-white border-blue-100' : 'bg-blue-50 border-blue-200 font-semibold'}`}
                >
                  <p className="text-gray-800 mb-2">{notif.message}</p>
                  <p className="text-sm text-gray-500 text-left">التاريخ والوقت: {new Date(notif.timestamp).toLocaleString()}</p>
                </div>
              ))}
            </div>
          )}
        </div>

        <button
          onClick={() => setCurrentScreen('employee')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={loading}
        >
          العودة
        </button>
      </div>
    </div>
  );
};


// ====================================================================
// شاشة الإرسالات المعلقة (Pending Submissions) للمدير
// ====================================================================
const PendingSubmissionsScreen = ({ setCurrentScreen, displayMessage }) => {
  const [pendingSubmissions, setPendingSubmissions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
      setIsAuthReady(true);
    });
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!isAuthReady) {
      setLoading(true);
      return;
    }

    setLoading(true);
    const pendingRef = collection(db, `artifacts/${appId}/public/data/pending_submissions`);
    const unsubscribe = onSnapshot(pendingRef, (snapshot) => {
      const submissionsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      submissionsList.sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)); // Most recent first
      setPendingSubmissions(submissionsList);
      setLoading(false);
    }, (error) => {
      console.error('Error fetching pending submissions:', error);
      displayMessage('خطأ في جلب الإرسالات المعلقة.', 'error');
      setLoading(false);
    });
    return () => unsubscribe();
  }, [isAuthReady, displayMessage]);

  const handleApprove = async (submission) => {
    setLoading(true);
    try {
      // Add data to respective collection based on type
      const { data, employee_id, employee_name, submitted_at } = submission;
      const submissionDate = new Date(submitted_at).toISOString().split('T')[0];
      const submissionTimestamp = submitted_at;

      if (data.hours !== null) {
        const workHoursRef = collection(db, `artifacts/${appId}/public/data/work_hours`);
        await addDoc(workHoursRef, {
          employee_id: employee_id,
          employee_name: employee_name,
          date: submissionDate,
          hours: data.hours,
          hourly_rate: data.hourly_rate || 0, // Assuming hourly_rate from employee doc on initial submission
          is_holiday: data.is_holiday || 0,
          timestamp: submissionTimestamp,
        });
      }
      if (data.amount !== null) {
        const amountsRef = collection(db, `artifacts/${appId}/public/data/amounts`);
        await addDoc(amountsRef, {
          employee_id: employee_id,
          employee_name: employee_name,
          date: submissionDate,
          shift_type: data.shift_type,
          amount: data.amount,
          timestamp: submissionTimestamp,
        });
      }
      if (data.notes !== null && data.notes.trim() !== '') {
        const notesRef = collection(db, `artifacts/${appId}/public/data/employee_notes`);
        await addDoc(notesRef, {
          employee_id: employee_id,
          employee_name: employee_name,
          message: data.notes.trim(),
          date: submissionDate,
          timestamp: submissionTimestamp,
          readByManager: false, // Manager just approved, so technically it's 'new' for manager's view
        });
      }

      // Delete from pending collection
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/pending_submissions`, submission.id));
      displayMessage('تمت الموافقة على الإرسال بنجاح!', 'success');
    } catch (error) {
      console.error('Error approving submission:', error);
      displayMessage('حدث خطأ أثناء الموافقة على الإرسال. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false);
    }
  };

  const handleReject = async (id) => {
    setLoading(true);
    try {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/pending_submissions`, id));
      displayMessage('تم رفض الإرسال بنجاح!', 'success');
    } catch (error) {
      console.error('Error rejecting submission:', error);
      displayMessage('حدث خطأ أثناء رفض الإرسال. يرجى المحاولة مرة أخرى.', 'error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-700 to-emerald-600 p-8">
      <div className="bg-white p-10 rounded-xl shadow-2xl w-full max-w-4xl mx-auto backdrop-filter backdrop-blur-md bg-opacity-90">
        <h2 className="text-3xl font-bold text-center text-blue-800 mb-8">الإرسالات المعلقة</h2>

        {loading && <LoadingSpinner />}

        <div className="mb-8 p-6 border border-gray-300 rounded-lg bg-gray-50 max-h-96 overflow-y-auto">
          <h3 className="text-xl font-semibold text-gray-700 mb-4">قائمة الإرسالات</h3>
          {loading ? (
            <LoadingSpinner />
          ) : pendingSubmissions.length === 0 ? (
            <p className="text-gray-600 text-center">لا توجد إرسالات معلقة حالياً.</p>
          ) : (
            <div className="space-y-4">
              {pendingSubmissions.map((submission) => (
                <div key={submission.id} className="p-4 bg-orange-50 rounded-lg shadow-md border border-orange-200">
                  <p className="font-semibold text-orange-800 mb-1">الموظف: {submission.employee_name}</p>
                  <p className="text-gray-700 mb-1">
                    تاريخ الإرسال: {new Date(submission.submitted_at).toLocaleString()}
                  </p>
                  <p className="text-gray-700 mb-2">
                    المحتوى: 
                    {submission.data.hours !== null && ` ساعات: ${submission.data.hours}`}
                    {submission.data.amount !== null && ` مبلغ: ${submission.data.amount} (${submission.data.shift_type})`}
                    {submission.data.notes !== null && ` ملاحظة: "${submission.data.notes}"`}
                    {submission.data.is_holiday ? ` (إجازة)` : ''}
                  </p>
                  <div className="flex justify-end space-x-3 mt-3">
                    <button
                      onClick={() => handleApprove(submission)}
                      className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm font-bold transition duration-300"
                      disabled={loading}
                    >
                      موافقة
                    </button>
                    <button
                      onClick={() => handleReject(submission.id)}
                      className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-sm font-bold transition duration-300"
                      disabled={loading}
                    >
                      رفض
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        <button
          onClick={() => setCurrentScreen('managerMenu')}
          className="mt-8 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mx-auto block"
          disabled={loading}
        >
          العودة للقائمة الرئيسية
        </button>
      </div>
    </div>
  );
};


// ====================================================================
// المكون الرئيسي للتطبيق
// ====================================================================
const App = () => {
  const [currentScreen, setCurrentScreen] = useState('login'); 
  const [loggedInUser, setLoggedInUser] = useState(null); 
  const [message, setMessage] = useState('');
  const [messageType, setMessageType] = useState('success');
  const [showMessage, setShowMessage] = useState(false);

  // Function to display alert messages - wrapped in useCallback
  const displayMessage = useCallback((msg, type = 'success') => {
    setMessage(msg);
    setMessageType(type);
    setShowMessage(true);
    setTimeout(() => {
      setShowMessage(false);
      setMessage(''); 
    }, 3000); 
  }, []); 

  // Handle successful login
  const handleLoginSuccess = (role, userData) => {
    setLoggedInUser({ role, data: userData });
    if (role === 'manager') {
      setCurrentScreen('managerMenu');
    } else {
      setCurrentScreen('employee');
    }
  };

  // Handle logout
  const handleLogout = async () => {
    try {
      await signOut(auth);
      setLoggedInUser(null);
      setCurrentScreen('login');
      displayMessage('تم تسجيل الخروج بنجاح!', 'success');
    } catch (error) {
      console.error('Error logging out:', error);
      displayMessage('حدث خطأ أثناء تسجيل الخروج. يرجى المحاولة مرة أخرى.', 'error');
    }
  };

  // Initialize Firebase and initial login
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error('Error in initial/anonymous login:', error);
          displayMessage('خطأ في تهيئة المستخدم.', 'error');
        }
      }
    });

    return () => unsubscribe(); 
  }, [displayMessage]); 

  // Render screen based on state
  const renderScreen = () => {
    switch (currentScreen) {
      case 'login':
        return <LoginScreen onLogin={handleLoginSuccess} displayMessage={displayMessage} />;
      case 'managerMenu':
        return <ManagerMenuScreen onLogout={handleLogout} setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} loggedInUser={loggedInUser} />;
      case 'employee':
        return <EmployeeScreen onLogout={handleLogout} displayMessage={displayMessage} loggedInUser={loggedInUser} setCurrentScreen={setCurrentScreen} />;
      case 'employeeManagement':
        return <EmployeeManagementScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} />;
      case 'amountsManagement':
        return <AmountsManagementScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} />;
      case 'salariesManagement':
        return <SalariesManagementScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} />;
      case 'notificationsManagement':
        return <NotificationsManagementScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} />;
      case 'employeeNotes':
        return <EmployeeNotesScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} />;
      case 'notificationLog':
        return <NotificationLogScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} loggedInUser={loggedInUser} />;
      case 'pendingSubmissions':
        return <PendingSubmissionsScreen setCurrentScreen={setCurrentScreen} displayMessage={displayMessage} />;
      default:
        return <LoginScreen onLogin={handleLoginSuccess} displayMessage={displayMessage} />;
    }
  };

  return (
    <div className="font-inter">
      {renderScreen()}
      {showMessage && <MessageOverlay message={message} type={messageType} onClose={() => setShowMessage(false)} />}
    </div>
  );
};

export default App;



